<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.433">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Björn Bornkamp and Kaspar Rufibach">
<meta name="dcterms.date" content="2024-01-18">

<title>Code examples for methodologies presented</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="princ_strat_example_files/libs/clipboard/clipboard.min.js"></script>
<script src="princ_strat_example_files/libs/quarto-html/quarto.js"></script>
<script src="princ_strat_example_files/libs/quarto-html/popper.min.js"></script>
<script src="princ_strat_example_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="princ_strat_example_files/libs/quarto-html/anchor.min.js"></script>
<link href="princ_strat_example_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="princ_strat_example_files/libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="princ_strat_example_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="princ_strat_example_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="princ_strat_example_files/libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul class="collapse">
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose"><span class="header-section-number">1</span> Purpose</a></li>
  <li><a href="#setup" id="toc-setup" class="nav-link" data-scroll-target="#setup"><span class="header-section-number">2</span> Setup</a></li>
  <li><a href="#generating-example-dataset" id="toc-generating-example-dataset" class="nav-link" data-scroll-target="#generating-example-dataset"><span class="header-section-number">3</span> Generating example dataset</a>
  <ul class="collapse">
  <li><a href="#assess-true-effects---population-dataset" id="toc-assess-true-effects---population-dataset" class="nav-link" data-scroll-target="#assess-true-effects---population-dataset"><span class="header-section-number">3.1</span> Assess “true” effects - population dataset</a></li>
  <li><a href="#clinical-trial-dataset" id="toc-clinical-trial-dataset" class="nav-link" data-scroll-target="#clinical-trial-dataset"><span class="header-section-number">3.2</span> Clinical trial dataset</a></li>
  </ul></li>
  <li><a href="#simple-analyses-of-clinical-trial-dataset" id="toc-simple-analyses-of-clinical-trial-dataset" class="nav-link" data-scroll-target="#simple-analyses-of-clinical-trial-dataset"><span class="header-section-number">4</span> Simple analyses of clinical trial dataset</a>
  <ul class="collapse">
  <li><a href="#overall-treatment-effect" id="toc-overall-treatment-effect" class="nav-link" data-scroll-target="#overall-treatment-effect"><span class="header-section-number">4.1</span> Overall treatment effect</a></li>
  <li><a href="#naive-analysis-vs-complete-placebo-group" id="toc-naive-analysis-vs-complete-placebo-group" class="nav-link" data-scroll-target="#naive-analysis-vs-complete-placebo-group"><span class="header-section-number">4.2</span> Naive analysis vs complete placebo group</a></li>
  </ul></li>
  <li><a href="#estimation-approaches-under-the-principal-ignorability-assumption" id="toc-estimation-approaches-under-the-principal-ignorability-assumption" class="nav-link" data-scroll-target="#estimation-approaches-under-the-principal-ignorability-assumption"><span class="header-section-number">5</span> Estimation approaches under the principal ignorability assumption</a>
  <ul class="collapse">
  <li><a href="#regression-adjustment" id="toc-regression-adjustment" class="nav-link" data-scroll-target="#regression-adjustment"><span class="header-section-number">5.1</span> Regression adjustment</a></li>
  <li><a href="#weighting" id="toc-weighting" class="nav-link" data-scroll-target="#weighting"><span class="header-section-number">5.2</span> Weighting</a></li>
  <li><a href="#multiple-imputation" id="toc-multiple-imputation" class="nav-link" data-scroll-target="#multiple-imputation"><span class="header-section-number">5.3</span> Multiple imputation</a></li>
  <li><a href="#summary-of-various-estimators" id="toc-summary-of-various-estimators" class="nav-link" data-scroll-target="#summary-of-various-estimators"><span class="header-section-number">5.4</span> Summary of various estimators</a></li>
  </ul></li>
  <li><a href="#sensitivity-analysis" id="toc-sensitivity-analysis" class="nav-link" data-scroll-target="#sensitivity-analysis"><span class="header-section-number">6</span> Sensitivity analysis</a></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references"><span class="header-section-number">7</span> References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Code examples for methodologies presented</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Björn Bornkamp and Kaspar Rufibach </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">January 18, 2024</p>
    </div>
  </div>
  
    
  </div>
  

</header>

<section id="purpose" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Purpose</h1>
<p>This document accompanies <span class="citation" data-cites="bornkamp_21">Bjoern Bornkamp et al. (<a href="#ref-bornkamp_21" role="doc-biblioref">2021</a>)</span>. The preprint is <span class="citation" data-cites="bornkamp_20">B. Bornkamp et al. (<a href="#ref-bornkamp_20" role="doc-biblioref">2020</a>)</span> and the accompanying github repository is available <a href="https://github.com/oncoestimand/princ_strat_drug_dev">here</a>. It provides an implementation of different analysis methods for principal stratum estimands motivated by the principal ignorability assumption. In addition an idea for a sensitivity analysis is proposed. <span class="citation" data-cites="wang_23">Wang et al. (<a href="#ref-wang_23" role="doc-biblioref">2023</a>)</span> provide further discussion of a sensitivity analysis for the principal ignorability assumption via multiple imputation.</p>
<p>In this document we focus on a time-to-event endpoint as they are currently mostly performed (i.e., based on the Cox model). Some of the analyses presented here would be easier to perform and/or interpret when using linear and collapsible summary measures like the difference in restricted mean survival time.</p>
</section>
<section id="setup" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Setup</h1>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>knitr<span class="sc">::</span>opts_chunk<span class="sc">$</span><span class="fu">set</span>(<span class="at">echo =</span> <span class="cn">FALSE</span>, <span class="at">cache =</span> <span class="cn">TRUE</span>)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Packages</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="co"># --------------------------------------------------------------</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>packages <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"data.table"</span>, <span class="st">"ggplot2"</span>, <span class="st">"survival"</span>, <span class="st">"survminer"</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"mvtnorm"</span>, <span class="st">"knitr"</span>, <span class="st">"reporttools"</span>)</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(packages)){<span class="fu">library</span>(packages[i], <span class="at">character.only =</span> <span class="cn">TRUE</span>)}</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># function to prettify output</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>prettyCox <span class="ot">&lt;-</span> <span class="cf">function</span>(mod, <span class="at">dig.coef =</span> <span class="dv">2</span>, <span class="at">dig.p =</span> <span class="dv">1</span>){</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  tab1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">summary</span>(mod)<span class="sc">$</span>conf.int), <span class="fu">summary</span>(mod)<span class="sc">$</span>coefficients)</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  tab1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">apply</span>(tab1[, <span class="fu">c</span>(<span class="dv">5</span>, <span class="dv">1</span>)], <span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>, disp, </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>        dig.coef), <span class="fu">displayCI</span>(<span class="fu">as.matrix</span>(tab1[, <span class="fu">c</span>(<span class="dv">3</span>, <span class="dv">4</span>)]), <span class="at">digit =</span> dig.coef), </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">formatPval</span>(tab1[, <span class="dv">9</span>], dig.p)))</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  tab1 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(<span class="fu">rownames</span>(<span class="fu">summary</span>(mod)<span class="sc">$</span>conf.int), tab1))</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">colnames</span>(tab1) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Variable"</span>, <span class="st">"Coefficient"</span>, <span class="st">"HR = exp(coef)"</span>, </span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>                      <span class="st">"95</span><span class="sc">\\</span><span class="st">% CI"</span>, <span class="st">"$p$-value"</span>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">kable</span>(tab1, <span class="at">row.names =</span> <span class="cn">FALSE</span>)</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="generating-example-dataset" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Generating example dataset</h1>
<p>In this section we generate a hypothetical example dataset to analyse. The dataset is loosely motivated by <span class="citation" data-cites="schmid_18">Schmid et al. (<a href="#ref-schmid_18" role="doc-biblioref">2018</a>)</span>, which reports results of a Phase 3 trial comparing the monoclonal antibody Atezolizumab versus placebo (both on top of chemotherapy) in terms of progression free survival (PFS). Survival functions of the two treatment arms are loosely motivated by Figure 2A in that paper. We assume that for some patients on the treatment arm anti-drug-antibodies (ADAs) were induced by the treatment. Interest then focuses on how presence of ADAs might impact the treatment effect versus placebo. Note that we assume here that the ADA status is available instantaneously after treatment start for every patient and before any potential PFS event. There might be events before the intercurrent event occurs which might make observation of the intercurrent event status impossible. Please consult the paper on how to perform estimation in these more challenging situations.</p>
<p>This section can be skipped in case there is no interest in a detailed description on how the data were generated.</p>
<p>We assume in this simulated example that the principal ignorability assumption is fulfilled and that there is one main confounder, which is a prognostic score <span class="math inline">\(X\)</span> with 4 equally likely categories (<span class="math inline">\(X = 1, 2, 3, 4\)</span>). <span class="math inline">\(X\)</span> has a strong impact on the potential PFS outcomes <span class="math inline">\(Y(0)\)</span> and <span class="math inline">\(Y(1)\)</span> as well as occurence of ADA on the treatment group <span class="math inline">\(S(1)\)</span>. For all patients we simulate all potential outcomes, <span class="math inline">\(Y(0)\)</span>, <span class="math inline">\(Y(1)\)</span> and <span class="math inline">\(S(1)\)</span>. Note that <span class="math inline">\(S(0) \equiv 0\)</span>, i.e.&nbsp;ADA cannot occurr on the control arm.</p>
<section id="assess-true-effects---population-dataset" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="assess-true-effects---population-dataset"><span class="header-section-number">3.1</span> Assess “true” effects - population dataset</h2>
<p>In a first step and as a benchmark, we generate the “true” treatment effect for patients that are ADA+ in the treatment arm, i.e.&nbsp;those with <span class="math inline">\(S(1) = 1\)</span>. To this end, we simulate from a very large number of patients, the “population”.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/data generation population_43205cd5ca2f63dbe5f247b060aebe2f">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="do">## define model quantities</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="fl">1e6</span>        <span class="co"># large sample</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>X_p <span class="ot">&lt;-</span> <span class="dv">4</span>        <span class="co"># number of categories of X</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>a <span class="ot">&lt;-</span> <span class="fl">0.5</span>        <span class="co"># governs P(S(1) = 1)</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="do">## generation of Y(1)</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>y1_a <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">1.2</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>y1_b <span class="ot">&lt;-</span> <span class="fl">0.25</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>y1_c <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="do">## generation of Y(0)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>y0_a <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.8</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>y0_b <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">0.5</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="co"># true proportion of censored observations</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>prob_cens <span class="ot">&lt;-</span> <span class="fl">0.2</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="do">## "true" treatment effect for patients with S(1) = 1</span></span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="do">## for a large dataset assuming we could measure S1 for all patients</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a><span class="do">## simulate covariate X (low X -&gt; high disease severity)</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>X_p, N, <span class="at">prob =</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> X_p, X_p), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="do">## permute treatment assignment</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, N <span class="sc">/</span> <span class="dv">2</span>), <span class="fu">rep</span>(<span class="dv">1</span>, N <span class="sc">/</span> <span class="dv">2</span>)))</span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a><span class="do">## generate S(1) for all patients</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="do">## with a = 0.5 --&gt; P(S(1) = 1) ~= 0.24</span></span>
<span id="cb2-31"><a href="#cb2-31" aria-hidden="true" tabindex="-1"></a>S1_prob <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(a <span class="sc">*</span> X))   </span>
<span id="cb2-32"><a href="#cb2-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-33"><a href="#cb2-33" aria-hidden="true" tabindex="-1"></a><span class="do">## S1 more likely to occur for high disease severity</span></span>
<span id="cb2-34"><a href="#cb2-34" aria-hidden="true" tabindex="-1"></a>S1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, S1_prob)       </span>
<span id="cb2-35"><a href="#cb2-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-36"><a href="#cb2-36" aria-hidden="true" tabindex="-1"></a><span class="do">## generate Y(1) for all patients, depending on Z, X and S(1)</span></span>
<span id="cb2-37"><a href="#cb2-37" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">rexp</span>(N, <span class="fu">exp</span>(y1_a <span class="sc">+</span> y1_b <span class="sc">*</span> S1 <span class="sc">+</span> y1_c <span class="sc">*</span> X))</span>
<span id="cb2-38"><a href="#cb2-38" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">rexp</span>(N, <span class="fu">exp</span>(y0_a             <span class="sc">+</span> y0_b <span class="sc">*</span> X))</span>
<span id="cb2-39"><a href="#cb2-39" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1 <span class="sc">*</span> Z <span class="sc">+</span> Y0 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Z)</span>
<span id="cb2-40"><a href="#cb2-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-41"><a href="#cb2-41" aria-hidden="true" tabindex="-1"></a><span class="do">## add uniform random censoring</span></span>
<span id="cb2-42"><a href="#cb2-42" aria-hidden="true" tabindex="-1"></a>event <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, N, <span class="at">prob =</span> <span class="fu">c</span>(prob_cens, <span class="dv">1</span><span class="sc">-</span> prob_cens), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb2-43"><a href="#cb2-43" aria-hidden="true" tabindex="-1"></a>Y[<span class="sc">!</span><span class="fu">as.logical</span>(event)] <span class="ot">&lt;-</span> <span class="fu">runif</span>(N <span class="sc">-</span> <span class="fu">sum</span>(event), <span class="dv">0</span>, Y[<span class="sc">!</span><span class="fu">as.logical</span>(event)])</span>
<span id="cb2-44"><a href="#cb2-44" aria-hidden="true" tabindex="-1"></a>adat <span class="ot">&lt;-</span> <span class="fu">data.table</span>(Y, Z, X, S1, event)</span>
<span id="cb2-45"><a href="#cb2-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-46"><a href="#cb2-46" aria-hidden="true" tabindex="-1"></a><span class="do">## display model coefficients</span></span>
<span id="cb2-47"><a href="#cb2-47" aria-hidden="true" tabindex="-1"></a>truth_S1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z <span class="sc">+</span> X, <span class="at">data =</span> adat[S1 <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb2-48"><a href="#cb2-48" aria-hidden="true" tabindex="-1"></a>truth_S0 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z <span class="sc">+</span> X, <span class="at">data =</span> adat[S1 <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb2-49"><a href="#cb2-49" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(truth_S1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.16</td>
<td style="text-align: left;">0.85</td>
<td style="text-align: left;">[0.85, 0.86]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
<tr class="even">
<td style="text-align: left;">X</td>
<td style="text-align: left;">-0.52</td>
<td style="text-align: left;">0.59</td>
<td style="text-align: left;">[0.59, 0.60]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(truth_S0)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.41</td>
<td style="text-align: left;">0.66</td>
<td style="text-align: left;">[0.66, 0.67]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
<tr class="even">
<td style="text-align: left;">X</td>
<td style="text-align: left;">-0.52</td>
<td style="text-align: left;">0.60</td>
<td style="text-align: left;">[0.59, 0.60]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The results from the model coefficients are as expected: We see an overall treatment effect that is attenuated in ADA+ patients.</p>
</section>
<section id="clinical-trial-dataset" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="clinical-trial-dataset"><span class="header-section-number">3.2</span> Clinical trial dataset</h2>
<p>Now we generate a clinical trial dataset from that same population, using the same approach as above.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/data generation_fe2db193915b108376b8608c2806755d">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="do">## number of patients</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">450</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>N <span class="ot">&lt;-</span> <span class="dv">2</span> <span class="sc">*</span> n </span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="do">## simulate covariate X (low X -&gt; high disease severity)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>X_p, N, <span class="at">prob =</span> <span class="fu">rep</span>(<span class="dv">1</span> <span class="sc">/</span> X_p, X_p), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="do">## permute treatment assignment</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>Z <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">0</span>, N <span class="sc">/</span> <span class="dv">2</span>), <span class="fu">rep</span>(<span class="dv">1</span>, N <span class="sc">/</span> <span class="dv">2</span>)))</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="do">## generate S(1) for all patients</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="do">## with a = 0.5 --&gt; P(S(1) = 1) ~= 0.24</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>S1_prob <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(a <span class="sc">*</span> X))   </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a><span class="do">## S1 more likely to occur for high disease severity</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>S1 <span class="ot">&lt;-</span> <span class="fu">rbinom</span>(N, <span class="dv">1</span>, S1_prob)       </span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="do">## generate Y(1) for all patients, depending on Z, X and S(1)</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>Y1 <span class="ot">&lt;-</span> <span class="fu">rexp</span>(N, <span class="fu">exp</span>(y1_a <span class="sc">+</span> y1_b <span class="sc">*</span> S1 <span class="sc">+</span> y1_c <span class="sc">*</span> X))</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>Y0 <span class="ot">&lt;-</span> <span class="fu">rexp</span>(N, <span class="fu">exp</span>(y0_a             <span class="sc">+</span> y0_b <span class="sc">*</span> X))</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>Y <span class="ot">&lt;-</span> Y1 <span class="sc">*</span> Z <span class="sc">+</span> Y0 <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> Z)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="do">## assume random censoring</span></span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>event <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, N, <span class="at">prob =</span> <span class="fu">c</span>(<span class="fl">0.2</span>, <span class="fl">0.8</span>), <span class="at">replace =</span> <span class="cn">TRUE</span>)</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>Y[<span class="sc">!</span><span class="fu">as.logical</span>(event)] <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="fu">sum</span>(<span class="sc">!</span>event), <span class="dv">0</span>, Y[<span class="sc">!</span><span class="fu">as.logical</span>(event)])</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>S1[Z <span class="sc">==</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="cn">NA</span>                  <span class="do">## S1 not observed on control arm</span></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>dat <span class="ot">&lt;-</span> <span class="fu">data.table</span>(Y, Z, X, S1, event)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="simple-analyses-of-clinical-trial-dataset" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Simple analyses of clinical trial dataset</h1>
<p>In this section we provide a quick overview of the dataset. Mimicking the “real world”, the data only contains information on the time to event outcome <span class="math inline">\(Y\)</span>, whether the event occured or was censored (event), the treatment indicator <span class="math inline">\(Z\)</span> as well as whether ADAs occurred (<span class="math inline">\(S\)</span>, only available on the treatment arm).</p>
<p>In practice more confounders <span class="math inline">\(X\)</span> would be used in the analysis. There might also be more variables (e.g.&nbsp;stratfication factors) that one might use for adjustment in the outcome model.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Basic summaries_7014a4ed42c2840f546391deb4db632d">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="do">## data structure (note S1 = NA on placebo)</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(dat, <span class="at">n =</span> <span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            Y Z X S1 event
 1:  5.074401 0 3 NA     1
 2:  4.644627 1 1  0     1
 3: 23.618640 1 3  0     1
 4:  1.503326 0 1 NA     0
 5:  2.800660 1 1  1     1
 6:  9.848447 1 2  1     1
 7: 15.685280 1 4  0     1
 8:  7.956613 1 1  0     1
 9:  8.705521 1 4  0     1
10: 21.574262 1 3  0     1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="do">## variable S1 on treatment arm</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="fu">with</span>(dat, <span class="fu">table</span>(S1, X))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   X
S1    1   2   3   4
  0  73  78 103  94
  1  38  31  18  15</code></pre>
</div>
</div>
<section id="overall-treatment-effect" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="overall-treatment-effect"><span class="header-section-number">4.1</span> Overall treatment effect</h2>
<div class="cell" data-hash="princ_strat_example_cache/html/plot_b6283613e56fb31705155ba857ed570a">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="do">## overall treatment effect</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat)</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">data =</span> dat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="princ_strat_example_files/figure-html/plot-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Now assess effect of *observed* S1 on outcome on treatment arm only</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> S1, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggsurvplot</span>(fit, <span class="at">data =</span> dat) <span class="sc">+</span> </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggtitle</span>(<span class="st">"Patients on treatment arm only"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="princ_strat_example_files/figure-html/plot-2.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="do">## Some simple model fits</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="do">## overall treatment effect</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>ov_tmt <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat)</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(ov_tmt)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.30</td>
<td style="text-align: left;">0.74</td>
<td style="text-align: left;">[0.64, 0.86]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="do">## analysis within subgroup on treatment arm</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>ov_tmt_s1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> S1, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(ov_tmt_s1)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">S1</td>
<td style="text-align: left;">0.53</td>
<td style="text-align: left;">1.71</td>
<td style="text-align: left;">[1.33, 2.19]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As expected, patients with <span class="math inline">\(S(1) = 1\)</span> have a shorter PFS on the treatment arm.</p>
</section>
<section id="naive-analysis-vs-complete-placebo-group" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="naive-analysis-vs-complete-placebo-group"><span class="header-section-number">4.2</span> Naive analysis vs complete placebo group</h2>
<p>The next question is: Does <span class="math inline">\(S\)</span> also impact the treatment effect vs placebo?</p>
<div class="cell" data-hash="princ_strat_example_cache/html/naive_72e84a48f1b41b89d5ba6b4b4f731736">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="do">## naive analyses versus complete placebo group</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>naive <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>               <span class="at">data =</span> dat[(Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|</span> Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>compl_placebo <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, </span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                       <span class="at">data =</span> dat[(Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|</span> Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(naive)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">0.12</td>
<td style="text-align: left;">1.13</td>
<td style="text-align: left;">[0.89, 1.44]</td>
<td style="text-align: left;">0.33</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(compl_placebo)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.40</td>
<td style="text-align: left;">0.67</td>
<td style="text-align: left;">[0.57, 0.78]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
</section>
<section id="estimation-approaches-under-the-principal-ignorability-assumption" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Estimation approaches under the principal ignorability assumption</h1>
<section id="regression-adjustment" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="regression-adjustment"><span class="header-section-number">5.1</span> Regression adjustment</h2>
<p>The first and simplest approach for analysing the data motivated by the principal ignorability assumption is to adjust for the confounders in a regression model. Validity of this approach relies on correctly specifying the regression model.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Regression adjustment_c5b8140f4c107de3c12c62dfaac167b4">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>reg_adj <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z <span class="sc">+</span> X, </span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>                 <span class="at">data =</span> dat[(Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">1</span>) <span class="sc">|</span> Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>reg_adj2 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z <span class="sc">+</span> X, </span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>                  <span class="at">data =</span> dat[(Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">0</span>) <span class="sc">|</span> Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(reg_adj)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.12</td>
<td style="text-align: left;">0.88</td>
<td style="text-align: left;">[0.69, 1.13]</td>
<td style="text-align: left;">0.32</td>
</tr>
<tr class="even">
<td style="text-align: left;">X</td>
<td style="text-align: left;">-0.53</td>
<td style="text-align: left;">0.59</td>
<td style="text-align: left;">[0.54, 0.65]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(reg_adj2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.46</td>
<td style="text-align: left;">0.63</td>
<td style="text-align: left;">[0.54, 0.74]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
<tr class="even">
<td style="text-align: left;">X</td>
<td style="text-align: left;">-0.51</td>
<td style="text-align: left;">0.60</td>
<td style="text-align: left;">[0.56, 0.65]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="weighting" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="weighting"><span class="header-section-number">5.2</span> Weighting</h2>
<p>A slightly more complex estimation approach that does not make a parametric assumption on how to adjust for the confounder <span class="math inline">\(X\)</span> (but an assumption on how <span class="math inline">\(S(1)\)</span> and X are related) is to utilize a weighting or multiple imputation approach.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Weighting approaches_57d4e2cd243b3d40a9de3348b72a77ec">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="do">## fit model for ADA occurence on treatment</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>fit <span class="ot">&lt;-</span> <span class="fu">glm</span>(S1 <span class="sc">~</span> X, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">1</span>], <span class="at">family =</span> <span class="fu">binomial</span>())</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="do">## predict probability of ADA on control</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>wgts <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>,], <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">1</span>], dat[Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>wgts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">1</span>])), wgts)</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="do">## analysis for treatment effect in subgroup</span></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>weighting <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat2, <span class="at">weights =</span> wgts)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(weighting)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.07</td>
<td style="text-align: left;">0.93</td>
<td style="text-align: left;">[0.73, 1.19]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="do">## can also produce a weighted Kaplan-Meier estimate for patients with S1</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>km <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">1</span>])</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>fit1 <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(<span class="fu">c</span>(<span class="dv">0</span>, km<span class="sc">$</span>time), <span class="fu">c</span>(<span class="dv">1</span>, km<span class="sc">$</span>surv), <span class="at">rule =</span> <span class="dv">2</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="do">## now perform weighted prediction under placebo arm</span></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>wgts <span class="ot">&lt;-</span> <span class="fu">predict</span>(fit, <span class="at">newdata =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>], <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>cfit <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>], <span class="at">weight =</span> wgts)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>s0 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>], <span class="at">weight =</span> wgts)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>fit0 <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(<span class="fu">c</span>(<span class="dv">0</span>, s0<span class="sc">$</span>time), <span class="fu">c</span>(<span class="dv">1</span>, s0<span class="sc">$</span>surv), <span class="at">rule =</span> <span class="dv">2</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>s0_2 <span class="ot">&lt;-</span> <span class="fu">survfit</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> <span class="dv">1</span>, <span class="at">data =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>fit0_2 <span class="ot">&lt;-</span> <span class="fu">approxfun</span>(<span class="fu">c</span>(<span class="dv">0</span>, s0_2<span class="sc">$</span>time), <span class="fu">c</span>(<span class="dv">1</span>, s0_2<span class="sc">$</span>surv), <span class="at">rule =</span> <span class="dv">2</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">fit1</span>(x), <span class="dv">0</span>, <span class="dv">30</span>, <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">ylim =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">1</span>), <span class="at">xlab =</span> <span class="st">"Time (Months)"</span>,</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">main =</span> <span class="st">"Kaplan-Meier Estimate"</span>, <span class="at">ylab=</span><span class="st">"Survival Probability"</span>)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">fit0</span>(x), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="dv">2</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="fu">curve</span>(<span class="fu">fit0_2</span>(x), <span class="at">add =</span> <span class="cn">TRUE</span>, <span class="at">col =</span> <span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"Z = 1, S(1) = 1"</span>, </span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"Z = 0 (weighted by P(S(1) = 1))"</span>, </span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>                              <span class="st">"Z = 0 (all)"</span>),</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>, <span class="at">lwd =</span> <span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="princ_strat_example_files/figure-html/Weighting%20approaches-1.png" class="img-fluid" width="672"></p>
</div>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="do">## treatment effect in complement</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>wgts <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">-</span><span class="fu">predict</span>(fit, <span class="at">newdata =</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>,], <span class="at">type =</span> <span class="st">"response"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>dat2 <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">0</span>], dat[Z <span class="sc">==</span> <span class="dv">0</span>])</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>wgts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="dv">1</span>, <span class="fu">nrow</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span> <span class="sc">&amp;</span> S1 <span class="sc">==</span> <span class="dv">0</span>])), wgts)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>tmt_compl <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat2, <span class="at">weights =</span> wgts)</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a><span class="fu">prettyCox</span>(tmt_compl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">Variable</th>
<th style="text-align: left;">Coefficient</th>
<th style="text-align: left;">HR = exp(coef)</th>
<th style="text-align: left;">95% CI</th>
<th style="text-align: left;"><span class="math inline">\(p\)</span>-value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Z</td>
<td style="text-align: left;">-0.36</td>
<td style="text-align: left;">0.70</td>
<td style="text-align: left;">[0.60, 0.82]</td>
<td style="text-align: left;">&lt; 0.0001</td>
</tr>
</tbody>
</table>
</div>
</div>
</section>
<section id="multiple-imputation" class="level2" data-number="5.3">
<h2 data-number="5.3" class="anchored" data-anchor-id="multiple-imputation"><span class="header-section-number">5.3</span> Multiple imputation</h2>
<p>The analysis using weighting does not account for uncertainty in estimated weights. An alternative is multiple imputation.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Multiple Imputation_7996d39a0ea8249d6044b6aa7ab2bae5">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="do">## multiple imputation approach</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>cf <span class="ot">&lt;-</span> <span class="fu">coef</span>(fit)</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>cov_mat <span class="ot">&lt;-</span> <span class="fu">vcov</span>(fit)</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>nSim <span class="ot">&lt;-</span> <span class="dv">200</span></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>sim_pars <span class="ot">&lt;-</span> <span class="fu">rmvnorm</span>(nSim, cf, cov_mat)</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>impute <span class="ot">&lt;-</span> <span class="cf">function</span>(x, par){</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  linpred <span class="ot">&lt;-</span> par[<span class="dv">1</span>] <span class="sc">+</span> par[<span class="dv">2</span>] <span class="sc">*</span> x</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  prob <span class="ot">&lt;-</span> <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>linpred))</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rbinom</span>(<span class="fu">length</span>(linpred), <span class="dv">1</span>, prob)</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>dat_trt0 <span class="ot">&lt;-</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>dat_trt1 <span class="ot">&lt;-</span> dat[Z <span class="sc">==</span> <span class="dv">1</span>, ]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>loghr <span class="ot">&lt;-</span> loghr_vr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> nSim, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSim){</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  ADA_imp <span class="ot">&lt;-</span> <span class="fu">impute</span>(dat_trt0<span class="sc">$</span>X, sim_pars[i, ])</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  dat_trt0i <span class="ot">&lt;-</span> dat_trt0</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>  dat_trt0i<span class="sc">$</span>S1 <span class="ot">&lt;-</span> ADA_imp</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>  dat_imp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_trt1, dat_trt0i)</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>  fit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat_imp[S1 <span class="sc">==</span> <span class="dv">1</span>, ])</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a>  fit0 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat_imp[S1 <span class="sc">==</span> <span class="dv">0</span>, ])</span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>  loghr[i,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">coef</span>(fit1), <span class="fu">coef</span>(fit0))</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>  loghr_vr[i,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">vcov</span>(fit1), <span class="fu">vcov</span>(fit0))</span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="do">## point estimate</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a><span class="fu">colMeans</span>(loghr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] -0.06280059 -0.35671675</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">exp</span>(<span class="fu">colMeans</span>(loghr))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.9391307 0.6999707</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>vr1 <span class="ot">&lt;-</span> <span class="fu">mean</span>(loghr_vr[, <span class="dv">1</span>]) <span class="sc">+</span> <span class="fu">var</span>(loghr[, <span class="dv">1</span>])</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>vr2 <span class="ot">&lt;-</span> <span class="fu">mean</span>(loghr_vr[, <span class="dv">2</span>]) <span class="sc">+</span> <span class="fu">var</span>(loghr[, <span class="dv">2</span>])</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sqrt</span>(vr1); <span class="fu">sqrt</span>(vr2)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.1922447</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 0.08909016</code></pre>
</div>
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>mi <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">colMeans</span>(loghr), <span class="fu">sqrt</span>(vr1), <span class="fu">sqrt</span>(vr2))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="summary-of-various-estimators" class="level2" data-number="5.4">
<h2 data-number="5.4" class="anchored" data-anchor-id="summary-of-various-estimators"><span class="header-section-number">5.4</span> Summary of various estimators</h2>
<p>Multiple imputation point estimate is similar to weighting, but now with larger standard errors.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Summary estimates_83dc2828843ef3e52a70bc6dd515f95a">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>approach <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">"Truth"</span>, <span class="st">"Naive"</span>, <span class="st">"Regression adjustment"</span>, <span class="st">"Weighting"</span>, </span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>              <span class="st">"Multiple imputation"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>est <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">coef</span>(truth_S1)[<span class="dv">1</span>], <span class="fu">coef</span>(naive)[<span class="dv">1</span>], <span class="fu">coef</span>(reg_adj)[<span class="dv">1</span>], </span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>         <span class="fu">coef</span>(weighting), mi[<span class="dv">1</span>])</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>se <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="cn">NA</span>, <span class="fu">sqrt</span>(<span class="fu">vcov</span>(naive)), <span class="fu">sqrt</span>(<span class="fu">vcov</span>(reg_adj)[<span class="dv">1</span>, <span class="dv">1</span>]), </span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sqrt</span>(<span class="fu">vcov</span>(weighting)[<span class="dv">1</span>, <span class="dv">1</span>]), mi[<span class="dv">3</span>])</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>tab <span class="ot">&lt;-</span> <span class="fu">data.table</span>(<span class="at">approach =</span> approach, <span class="at">estimate =</span> <span class="fu">round</span>(est, <span class="dv">3</span>), </span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>                  <span class="at">se =</span> <span class="fu">round</span>(se, <span class="dv">3</span>), <span class="st">"hazard ratio"</span> <span class="ot">=</span> <span class="fu">round</span>(<span class="fu">exp</span>(est), <span class="dv">3</span>))</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a><span class="fu">kable</span>(tab)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<table class="table table-sm table-striped small">
<thead>
<tr class="header">
<th style="text-align: left;">approach</th>
<th style="text-align: right;">estimate</th>
<th style="text-align: right;">se</th>
<th style="text-align: right;">hazard ratio</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td style="text-align: left;">Truth</td>
<td style="text-align: right;">-0.157</td>
<td style="text-align: right;">NA</td>
<td style="text-align: right;">0.855</td>
</tr>
<tr class="even">
<td style="text-align: left;">Naive</td>
<td style="text-align: right;">0.121</td>
<td style="text-align: right;">0.124</td>
<td style="text-align: right;">1.129</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Regression adjustment</td>
<td style="text-align: right;">-0.125</td>
<td style="text-align: right;">0.126</td>
<td style="text-align: right;">0.883</td>
</tr>
<tr class="even">
<td style="text-align: left;">Weighting</td>
<td style="text-align: right;">-0.069</td>
<td style="text-align: right;">0.122</td>
<td style="text-align: right;">0.933</td>
</tr>
<tr class="odd">
<td style="text-align: left;">Multiple imputation</td>
<td style="text-align: right;">-0.063</td>
<td style="text-align: right;">0.192</td>
<td style="text-align: right;">0.939</td>
</tr>
</tbody>
</table>
</div>
</div>
<p>As an overall conclusion, results using both regression adjustment as well as weighting approaches point towards the fact that the treatment effect in the subgroup for which <span class="math inline">\(S(1)=1\)</span> is a bit larger (smaller log-HR) and closer to the true effect, than compared to the effect based on the naive analysis versus the complete placebo group. This is because patients with <span class="math inline">\(S(1)=1\)</span> generally have a worse prognosis (independent on which treatment group they are).</p>
</section>
</section>
<section id="sensitivity-analysis" class="level1" data-number="6">
<h1 data-number="6"><span class="header-section-number">6</span> Sensitivity analysis</h1>
<p>As discussed in <span class="citation" data-cites="bornkamp_21">Bjoern Bornkamp et al. (<a href="#ref-bornkamp_21" role="doc-biblioref">2021</a>)</span>, the principal ignorability assumption is unverifiable. In this section we propose a sensitivity analysis. The essential information missing for the analysis of interest is how <span class="math inline">\(Y(0) | S(1) = 1\)</span> and <span class="math inline">\(Y(0) | S(1) = 0\)</span> are related to each other, i.e.&nbsp;what impact does <span class="math inline">\(S(1)\)</span> have on <span class="math inline">\(Y(0)\)</span>. As <span class="math inline">\(S(1)\)</span> and <span class="math inline">\(Y(0)\)</span> are not jointly observed this is unknown.</p>
<p>Here we propose a sensitivity analysis where we impute <span class="math inline">\(S(1)\)</span> on the placebo arm. This will result in a specific HR quantifiying the effect that <span class="math inline">\(S(1)\)</span> might have on <span class="math inline">\(Y(0)\)</span>. Then we plot the HR of <span class="math inline">\(S(1)\)</span> on <span class="math inline">\(Y(0)\)</span> versus log(HR) in the subgroup of interest.</p>
<p>The idea of this analysis is as follows:</p>
<ul>
<li>Go randomly through different ways of assigning <span class="math inline">\(S(1)\)</span> to the control patients, so that the overall proportion of <span class="math inline">\(S(1) = 1\)</span> is similar to the treatment arm.</li>
<li>For each allocation we can calculate the HR of <span class="math inline">\(S(1) = 1\)</span> vs <span class="math inline">\(S(1) = 0\)</span> on the control arm.</li>
<li>Plot the log(HR) of treatment in <span class="math inline">\(S(1) = 1\)</span> and <span class="math inline">\(S(1) = 0\)</span> against the HR of <span class="math inline">\(S(1) = 1\)</span> vs <span class="math inline">\(S(1) = 0\)</span> on the control arm.</li>
</ul>
<p>To cover the range of different HRs a biased sampling is used.</p>
<div class="cell" data-hash="princ_strat_example_cache/html/Sensitivity analysis_88744214aa15c92c321535fd957761cc">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>dat_Z0 <span class="ot">&lt;-</span> dat[Z <span class="sc">==</span> <span class="dv">0</span>, ]</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>dat_Z1 <span class="ot">&lt;-</span> dat[Z <span class="sc">==</span> <span class="dv">1</span>, ]</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>sm <span class="ot">&lt;-</span> <span class="fu">sum</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span>, ]<span class="sc">$</span>S1 <span class="sc">==</span> <span class="dv">1</span>)</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>n1 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat[Z <span class="sc">==</span> <span class="dv">1</span>, ])</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>n0 <span class="ot">&lt;-</span> <span class="fu">nrow</span>(dat[Z <span class="sc">==</span> <span class="dv">0</span>, ])</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="do">## normalized rank (used for biased sampling later)</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>norm_rank <span class="ot">&lt;-</span> <span class="fu">rank</span>(dat_Z0<span class="sc">$</span>Y) <span class="sc">/</span> (n0 <span class="sc">+</span> <span class="dv">1</span>) </span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>nSim <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>loghr <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="at">nrow =</span> nSim, <span class="at">ncol =</span> <span class="dv">2</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>hr <span class="ot">&lt;-</span> <span class="fu">numeric</span>(nSim)</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>nSim){</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="do">## sample from posterior for P(S1 = 1) with uniformative prior</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  pp <span class="ot">&lt;-</span> <span class="fu">rbeta</span>(<span class="dv">1</span>, sm <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span>, n1 <span class="sc">-</span> sm <span class="sc">+</span> <span class="dv">1</span> <span class="sc">/</span> <span class="dv">3</span>) </span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="do">## now randomly pick who would have S(1) = 1 in the control group to</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="do">## efficiently explore also "extreme" allocations sometimes favor</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  <span class="do">## patients with long (or short) event (or censoring) time to have</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="do">## S(1) = 1.</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  ind <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  power <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">1</span>, <span class="dv">0</span>, <span class="dv">5</span>)</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ind <span class="sc">==</span> <span class="dv">0</span>){probs <span class="ot">&lt;-</span> norm_rank <span class="sc">^</span> power}</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(ind <span class="sc">==</span> <span class="dv">1</span>){probs <span class="ot">&lt;-</span> (<span class="dv">1</span> <span class="sc">-</span> norm_rank) <span class="sc">^</span> power}</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>  sel <span class="ot">&lt;-</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span>n0, pp <span class="sc">*</span> n0, <span class="at">prob =</span> probs)</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>  no_sel <span class="ot">&lt;-</span> <span class="fu">setdiff</span>(<span class="dv">1</span><span class="sc">:</span>n0, sel)</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>  S1_imp <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="dv">0</span>, n0)</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>  S1_imp[sel] <span class="ot">&lt;-</span> <span class="dv">1</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>  <span class="do">## this calculates the impact S(1) has on Y(0) for this imputation</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>  <span class="do">## measured in terms of the log-hazard ratio</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>  hr[i] <span class="ot">&lt;-</span> <span class="fu">coef</span>(<span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> S1_imp, <span class="at">data =</span> dat_Z0))</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>  dat_Z0i <span class="ot">&lt;-</span> dat_Z0</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>  dat_Z0i<span class="sc">$</span>S1 <span class="ot">&lt;-</span> S1_imp</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>  dat_imp <span class="ot">&lt;-</span> <span class="fu">rbind</span>(dat_Z1, dat_Z0i)</span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>  fit1 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat_imp[S1 <span class="sc">==</span> <span class="dv">1</span>, ])</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>  fit0 <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat_imp[S1 <span class="sc">==</span> <span class="dv">0</span>, ])</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>  loghr[i,] <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">coef</span>(fit1), <span class="fu">coef</span>(fit0))</span>
<span id="cb29-39"><a href="#cb29-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-40"><a href="#cb29-40" aria-hidden="true" tabindex="-1"></a>fitoverall <span class="ot">&lt;-</span> <span class="fu">coxph</span>(<span class="fu">Surv</span>(Y, event) <span class="sc">~</span> Z, <span class="at">data =</span> dat)</span>
<span id="cb29-41"><a href="#cb29-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-42"><a href="#cb29-42" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(hr, loghr[,<span class="dv">1</span>], <span class="at">ylim =</span> <span class="fu">range</span>(loghr), <span class="at">pch =</span> <span class="dv">19</span>,</span>
<span id="cb29-43"><a href="#cb29-43" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"log(HR) of S(1) = 1 vs S(1) = 0 on placebo arm"</span>, </span>
<span id="cb29-44"><a href="#cb29-44" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="st">"log(HR) of treatment"</span>)</span>
<span id="cb29-45"><a href="#cb29-45" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="dv">0</span>, <span class="at">lty =</span> <span class="dv">2</span>)</span>
<span id="cb29-46"><a href="#cb29-46" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(hr, loghr[, <span class="dv">1</span>], <span class="at">col =</span> <span class="st">"black"</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb29-47"><a href="#cb29-47" aria-hidden="true" tabindex="-1"></a><span class="fu">points</span>(hr, loghr[, <span class="dv">2</span>], <span class="at">col =</span> <span class="st">"red"</span>, <span class="at">pch =</span> <span class="dv">19</span>)</span>
<span id="cb29-48"><a href="#cb29-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-49"><a href="#cb29-49" aria-hidden="true" tabindex="-1"></a><span class="do">## overall treatment effect</span></span>
<span id="cb29-50"><a href="#cb29-50" aria-hidden="true" tabindex="-1"></a><span class="fu">abline</span>(<span class="at">h =</span> <span class="fu">coef</span>(fitoverall), <span class="at">lwd =</span> <span class="dv">2</span>, <span class="at">col =</span> <span class="st">"blue"</span>) </span>
<span id="cb29-51"><a href="#cb29-51" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"bottomleft"</span>, <span class="fu">c</span>(<span class="st">"S(1) = 1"</span>, <span class="st">"S(1) = 0"</span>, <span class="st">"Overall"</span>), </span>
<span id="cb29-52"><a href="#cb29-52" aria-hidden="true" tabindex="-1"></a>       <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"black"</span>, <span class="st">"red"</span>, <span class="st">"blue"</span>),</span>
<span id="cb29-53"><a href="#cb29-53" aria-hidden="true" tabindex="-1"></a>       <span class="at">pch =</span> <span class="fu">c</span>(<span class="dv">19</span>, <span class="dv">19</span>, <span class="sc">-</span><span class="dv">1</span>), <span class="at">lwd =</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">1</span>, <span class="sc">-</span><span class="dv">1</span>, <span class="dv">2</span>), <span class="at">title =</span> <span class="st">"Population"</span>, <span class="at">bg =</span> <span class="st">"white"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<p><img src="princ_strat_example_files/figure-html/Sensitivity%20analysis-1.png" class="img-fluid" width="672"></p>
</div>
</div>
<p>From this plot it can be seen that the treatment effect in the subpopulation with <span class="math inline">\(S(1) = 1\)</span> depends quite strongly on how much <span class="math inline">\(S(1)\)</span> impacts <span class="math inline">\(Y(0)\)</span>. The observed impact of <span class="math inline">\(S(1)\)</span> on <span class="math inline">\(Y(1)\)</span> (unadjusted for <span class="math inline">\(X\)</span>) lead to a log-HR of around 0.28 so that one might speculate that the impact of <span class="math inline">\(S(1)\)</span> on <span class="math inline">\(Y(0)\)</span> would be smaller than that. In this area from 0 to 0.28 one can still see that one would observe a benefit for the treatment group in the subgroup with <span class="math inline">\(S(1)=1\)</span>.</p>
<p><span class="citation" data-cites="wang_23">Wang et al. (<a href="#ref-wang_23" role="doc-biblioref">2023</a>)</span> provide further discussion of a sensitivity analysis for the principal ignorability assumption via multiple imputation</p>
</section>
<section id="references" class="level1 unnumbered" data-number="7">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography"><h2 class="anchored quarto-appendix-heading">7 References</h2><div id="refs" class="references csl-bib-body hanging-indent" role="list">
<div id="ref-bornkamp_21" class="csl-entry" role="listitem">
Bornkamp, Bjoern, Kaspar Rufibach, Jianchang Lin, Yi Liu, Devan V. Mehrotra, Satrajit Roychoudhury, Heinz Schmidli, Yue Shentu, and Marcel Wolbers. 2021. <span>“Principal Stratum Strategy: Potential Role in Drug Development.”</span> <em>Pharmaceutical Statistics</em> 20 (4): 737–51. <a href="https://doi.org/10.1002/pst.2104">https://doi.org/10.1002/pst.2104</a>.
</div>
<div id="ref-bornkamp_20" class="csl-entry" role="listitem">
Bornkamp, B., K. Rufibach, J. Lin, Y. Liu, D. Mehrotra, S. Roychoudhury, H. Schmidli, Y. Shentu, and M. Wolbers. 2020. <span>“Principal Stratum Strategy: Potential Role in Drug Development.”</span> Industry Working Group "Estimands in Oncology". <a href="https://arxiv.org/abs/2008.05406">https://arxiv.org/abs/2008.05406</a>.
</div>
<div id="ref-schmid_18" class="csl-entry" role="listitem">
Schmid, Peter, Sylvia Adams, Hope S Rugo, Andreas Schneeweiss, Carlos H Barrios, Hiroji Iwata, Véronique Diéras, et al. 2018. <span>“Atezolizumab and Nab-Paclitaxel in Advanced Triple-Negative Breast Cancer.”</span> <em>The New England Journal of Medicine</em> 379: 2108–21. <a href="https://doi.org/10.1056/NEJMoa1809615">https://doi.org/10.1056/NEJMoa1809615</a>.
</div>
<div id="ref-wang_23" class="csl-entry" role="listitem">
Wang, C., Y. Zhang, F. Mealli, and B. Bornkamp. 2023. <span>“<span class="nocase"><span>S</span>ensitivity analyses for the principal ignorability assumption using multiple imputation</span>.”</span> <em>Pharm Stat</em> 22 (1): 64–78.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->



</body></html>